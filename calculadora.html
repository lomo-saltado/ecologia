<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Calculadora</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#000000"/>
    <link rel="manifest" id="manifest">
    
    <!-- Apple PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Calculadora">
    <link rel="apple-touch-icon" id="apple-icon">

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --safe-area-inset-bottom: env(safe-area-inset-bottom, 1rem);
        }
        
        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: #000;
            color: #fff;
            display: flex;
            flex-direction: column;
        }
        
        /* Estilo base de los botones */
        .btn {
            border-radius: 9999px;
            font-size: 2rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.1s ease-in-out;
            -webkit-tap-highlight-color: transparent; /* Remove tap highlight on iOS */
        }

        /* Botones grises (números) */
        .btn-dark-gray { background-color: #333333; }
        .btn-dark-gray:active { background-color: #737373; }

        /* Botones gris claro (operadores superiores) */
        .btn-light-gray { background-color: #A5A5A5; color: #000; }
        .btn-light-gray:active { background-color: #D9D9D9; }
        
        /* Botones naranjas (operadores laterales) */
        .btn-orange { background-color: #F1A33C; }
        .btn-orange:active { background-color: #F8D5A1; }

        /* Botón activo (para cuando un operador está seleccionado) */
        .btn-orange.active {
            background-color: #FFFFFF;
            color: #F1A33C;
        }

    </style>
</head>
<body class="p-4">

    <!-- Contenedor principal que ocupa toda la pantalla -->
    <div class="flex flex-col h-full w-full">
        <!-- Pantalla de la calculadora -->
        <div class="flex-grow flex items-end justify-end pb-4">
            <input type="text" id="display" class="w-full bg-transparent text-right text-8xl font-light border-0 focus:ring-0 p-0" readonly value="0">
        </div>

        <!-- Botones de la calculadora -->
        <div class="grid grid-cols-4 gap-3" style="padding-bottom: var(--safe-area-inset-bottom);">
            <!-- Fila 1 -->
            <button id="clearBtn" onclick="clearDisplay()" class="btn btn-light-gray aspect-square">AC</button>
            <button onclick="toggleSign()" class="btn btn-light-gray aspect-square">+/-</button>
            <button onclick="handleOperator('%')" class="btn btn-light-gray aspect-square">%</button>
            <button id="op-divide" onclick="handleOperator('/')" class="btn btn-orange aspect-square text-4xl">/</button>

            <!-- Fila 2 -->
            <button onclick="appendNumber('7')" class="btn btn-dark-gray aspect-square">7</button>
            <button onclick="appendNumber('8')" class="btn btn-dark-gray aspect-square">8</button>
            <button onclick="appendNumber('9')" class="btn btn-dark-gray aspect-square">9</button>
            <button id="op-multiply" onclick="handleOperator('*')" class="btn btn-orange aspect-square text-4xl">×</button>

            <!-- Fila 3 -->
            <button onclick="appendNumber('4')" class="btn btn-dark-gray aspect-square">4</button>
            <button onclick="appendNumber('5')" class="btn btn-dark-gray aspect-square">5</button>
            <button onclick="appendNumber('6')" class="btn btn-dark-gray aspect-square">6</button>
            <button id="op-subtract" onclick="handleOperator('-')" class="btn btn-orange aspect-square text-4xl">-</button>

            <!-- Fila 4 -->
            <button onclick="appendNumber('1')" class="btn btn-dark-gray aspect-square">1</button>
            <button onclick="appendNumber('2')" class="btn btn-dark-gray aspect-square">2</button>
            <button onclick="appendNumber('3')" class="btn btn-dark-gray aspect-square">3</button>
            <button id="op-add" onclick="handleOperator('+')" class="btn btn-orange aspect-square text-4xl">+</button>
            
            <!-- Fila 5 -->
            <button onclick="appendNumber('0')" class="btn btn-dark-gray col-span-2 aspect-auto text-left pl-8">0</button>
            <button onclick="appendNumber('.')" class="btn btn-dark-gray aspect-square">,</button>
            <button onclick="calculateResult()" class="btn btn-orange aspect-square text-4xl">=</button>
        </div>
    </div>

    <script>
        const display = document.getElementById('display');
        const clearBtn = document.getElementById('clearBtn');
        
        let currentValue = '0';
        let previousValue = null;
        let operator = null;
        let waitingForSecondValue = false;

        function updateDisplay() {
            let valueToDisplay = currentValue.replace('.', ',');
            const limit = 9;
            if (valueToDisplay.length > limit) {
                if (valueToDisplay.includes(',')) {
                     valueToDisplay = parseFloat(currentValue).toPrecision(limit - Math.floor(parseFloat(currentValue)).toString().length);
                } else {
                     valueToDisplay = parseFloat(currentValue).toExponential(2);
                }
            }
            
            display.value = new Intl.NumberFormat('es-ES', { maximumFractionDigits: 8 }).format(valueToDisplay.replace(',', '.'));
            
            if (display.value.length > 9) {
                display.classList.remove('text-8xl');
                display.classList.add('text-6xl');
            } else {
                display.classList.remove('text-6xl');
                display.classList.add('text-8xl');
            }
            
            clearBtn.innerText = currentValue === '0' && !previousValue ? 'AC' : 'C';
        }

        function appendNumber(number) {
            if (waitingForSecondValue) {
                currentValue = number;
                waitingForSecondValue = false;
            } else {
                if (currentValue === '0' && number !== '.') {
                    currentValue = number;
                } else if (number === '.' && currentValue.includes('.')) {
                    return;
                } else {
                    currentValue += number;
                }
            }
            updateDisplay();
            removeActiveOperator();
        }
        
        function clearDisplay() {
            currentValue = '0';
            previousValue = null;
            operator = null;
            waitingForSecondValue = false;
            updateDisplay();
            removeActiveOperator();
        }

        function toggleSign() {
            if (currentValue === '0') return;
            currentValue = (parseFloat(currentValue) * -1).toString();
            updateDisplay();
        }

        function handleOperator(nextOperator) {
            const value = parseFloat(currentValue);

            if (operator && waitingForSecondValue) {
                operator = nextOperator;
                setActiveOperator(nextOperator);
                return;
            }

            if (previousValue === null) {
                previousValue = value;
            } else if (operator) {
                const result = performCalculation();
                currentValue = result.toString();
                previousValue = result;
                updateDisplay();
            }

            waitingForSecondValue = true;
            operator = nextOperator;
            setActiveOperator(nextOperator);
        }

        function performCalculation() {
            if (operator === null || previousValue === null) return parseFloat(currentValue);
            const current = parseFloat(currentValue);
            let result = 0;
            switch (operator) {
                case '+': result = previousValue + current; break;
                case '-': result = previousValue - current; break;
                case '*': result = previousValue * current; break;
                case '/': result = previousValue / current; break;
                case '%': result = previousValue % current; break;
                default: return current;
            }
            return result;
        }

        function calculateResult() {
            if(operator === null) return;
            const result = performCalculation();
            currentValue = result.toString();
            operator = null;
            previousValue = null;
            waitingForSecondValue = false;
            updateDisplay();
            removeActiveOperator();
        }
        
        function setActiveOperator(op) {
            removeActiveOperator();
            let btnId;
            if (op === '/') btnId = 'op-divide';
            else if (op === '*') btnId = 'op-multiply';
            else if (op === '-') btnId = 'op-subtract';
            else if (op === '+') btnId = 'op-add';
            
            if(btnId) document.getElementById(btnId).classList.add('active');
        }

        function removeActiveOperator() {
            document.querySelectorAll('.btn-orange.active').forEach(btn => btn.classList.remove('active'));
        }

        updateDisplay();

        // --- Lógica de la Web App (PWA) ---
        const svgIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="192" height="192" viewBox="0 0 24 24" fill="#F1A33C"><rect x="4" y="4" width="16" height="16" rx="2" ry="2"></rect><line x1="8" y1="12" x2="16" y2="12" stroke="white" stroke-width="2"></line></svg>`;
        const iconUrl = `data:image/svg+xml;base64,${btoa(svgIcon)}`;
        document.getElementById('apple-icon').href = iconUrl;
        
        const manifest = {
            "name": "Calculadora",
            "short_name": "Calculadora",
            "start_url": ".",
            "display": "fullscreen",
            "background_color": "#000000",
            "theme_color": "#000000",
            "description": "Calculadora estilo iOS.",
            "icons": [{"src": iconUrl, "sizes": "192x192", "type": "image/svg+xml"}]
        };
        const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        const manifestUrl = URL.createObjectURL(manifestBlob);
        document.getElementById('manifest').href = manifestUrl;

    </script>
</body>
</html>
```

He realizado algunos cambios. Eliminé el código del Service Worker que causaba el error de registro. La aplicación ahora debería funcionar sin ese err
